--------------------------------------------------------------------------------------------------------------
  										--task_1--
--------------------------------------------------------------------------------------------------------------

use NETFLIX;
-- 1  Which is the most watched movie? 
SELECT TOP 1 TITLE, SUM(USER_DURATION) AS WATCH_TIME,COD.CONTENT_ID
FROM CONSUMPTION_DATA AS COD
INNER JOIN CATALOGUE_DATA AS CAD
ON COD.CONTENT_ID=CAD.CONTENT_ID
GROUP BY TITLE, COD.CONTENT_ID
ORDER BY WATCH_TIME DESC

-- 2	Which movies has not been watched at all?
SELECT TOP 10 TITLE, SUM(USER_DURATION) AS WATCH_TIME,COD.CONTENT_ID
FROM CONSUMPTION_DATA AS COD
INNER JOIN CATALOGUE_DATA AS CAD
ON COD.CONTENT_ID=CAD.CONTENT_ID
GROUP BY TITLE, COD.CONTENT_ID
order by WATCH_TIME ASC

-- 3	Calculate the % of total revenue generated by the different plan types
SELECT PLAN_TYPE,SUM(AMOUNT_PAID) AS REVENUE,
sum(amount_paid)/(SELECT SUM(AMOUNT_PAID) 
                  FROM SUBSCRIPTION_DATA WHERE PLAN_TYPE IS NOT NULL)*100 AS [REVENUE%]
FROM SUBSCRIPTION_DATA 
WHERE PLAN_TYPE IS NOT NULL
GROUP BY PLAN_TYPE

-- 4	Which movies are helping us aquire most number of users?
SELECT TOP 10 CD.CONTENT_ID,TITLE, SUM(USER_DURATION) AS WATCH_TIME
FROM CONSUMPTION_DATA AS COD
INNER JOIN RATING_DATA AS RD
ON COD.USERSESSIONID=RD.USERSESSIONID
AND COD.USERID=RD.USERID
INNER JOIN CATALOGUE_DATA AS CD
ON CD.CONTENT_ID=COD.CONTENT_ID
WHERE RD.RATING IN('AWESOME','GOOD')
GROUP BY TITLE,CD.CONTENT_ID
ORDER BY WATCH_TIME DESC

--5	All content which has been live for last 6 months
select title
from CATALOGUE_DATA
WHERE STATUS='LIVE'
 AND DATE_ADDED>=(SELECT DATEADD(MONTH,-6,MAX(DATE_ADDED)) FROM CATALOGUE_DATA)

------------------------------------------------------------------------------------------------------------------
                                      --task_2--
------------------------------------------------------------------------------------------------------------------
--1	Total Subscriptions
SELECT COUNT(SUBSCRIPTION_KEY) AS TOTAL_SUBSCRIPTIONS
FROM SUBSCRIPTION_DATA 

--2	Total Revenue from Subscriptions
SELECT SUM(AMOUNT_PAID) AS TOTAL_REVENUE
FROM SUBSCRIPTION_DATA 

--3	Average Revenue per Subscription
SELECT  PLAN_TYPE, AVG(AMOUNT_PAID)AS AVG_REVENUE
FROM SUBSCRIPTION_DATA
WHERE PLAN_TYPE IS NOT NULL
GROUP BY PLAN_TYPE

--4	Subscriptions percentage by plan type
SELECT PLAN_TYPE, 
COUNT(SUBSCRIPTION_KEY) / CAST ( (SELECT COUNT(SUBSCRIPTION_KEY)FROM SUBSCRIPTION_DATA ) AS FLOAT)* 100 AS [SUBS%]
FROM SUBSCRIPTION_DATA
WHERE PLAN_TYPE IS NOT NULL
GROUP BY PLAN_TYPE
ORDER BY [SUBS%] DESC

--5	Subscriptions percentage by plan duration
SELECT subscription_length, 
COUNT(subscription_key) / CAST( (SELECT COUNT(subscription_key) FROM subscription_data) AS FLOAT )*100 AS [SUBS%]
FROM subscription_data
GROUP BY subscription_length
ORDER BY [SUBS%] DESC

--6	Calculate the total revenue generated per month.

select MONTH(subscription_created_date) AS MONTHS, SUM(AMOUNT_PAID) AS REVENUE 
FROM SUBSCRIPTION_DATA
GROUP BY MONTH(subscription_created_date)

--7	Monthly New Subscriptions:
SELECT MONTH(SUBSCRIPTION_CREATED_TIME) AS MONTHS , COUNT(SUBSCRIPTION_KEY) AS  NEW_SUBSCRIPTIONS
FROM SUBSCRIPTION_DATA
GROUP BY MONTH(SUBSCRIPTION_CREATED_TIME)
ORDER BY MONTHS 

SELECT MONTH(subscription_created_date) AS MONTHS , COUNT(SUBSCRIPTION_KEY) AS  NEW_SUBSCRIPTIONS
FROM SUBSCRIPTION_DATA
GROUP BY MONTH(subscription_created_date)
ORDER BY MONTHS 

--8	Understanding when users are purchasing
SELECT MONTH(SUBSCRIPTION_CREATED_TIME) AS MONTHS , COUNT(SUBSCRIPTION_KEY) AS  NEW_SUBSCRIPTIONS
FROM SUBSCRIPTION_DATA
GROUP BY MONTH(SUBSCRIPTION_CREATED_TIME)
ORDER BY NEW_SUBSCRIPTIONS

SELECT MONTH(subscription_created_date) AS MONTHS , COUNT(SUBSCRIPTION_KEY) AS  NEW_SUBSCRIPTIONS
FROM SUBSCRIPTION_DATA
GROUP BY MONTH(subscription_created_date)
ORDER BY NEW_SUBSCRIPTIONS

--------------------------------------------------------------------------------------------------------------------
                                 --TASK-3--
--------------------------------------------------------------------------------------------------------------------

--1	Total content
SELECT COUNT(TITLE) AS TOTAL_CONTENT 
FROM CATALOGUE_DATA

-- 2	Total content split by paid & free
SELECT ACCESSLEVEL ,
COUNT(TITLE)/ CAST( ( SELECT COUNT(TITLE)FROM CATALOGUE_DATA)AS FLOAT)*100 AS [CONTENT%]
FROM CATALOGUE_DATA
GROUP BY ACCESSLEVEL

-- 3	Total content split by status
SELECT [STATUS],
COUNT(TITLE)/ CAST( ( SELECT COUNT(TITLE)FROM CATALOGUE_DATA)AS FLOAT)*100 AS [CONTENT%]
FROM CATALOGUE_DATA
GROUP BY [STATUS]

--4	Month of month content added to the paltform
SELECT MONTHS, CONTENT_ADDED, CONTENT_ADDED - PREVIOUS_COUNT AS MOM
FROM (
       SELECT MONTH(DATE_ADDED) AS MONTHS ,COUNT(TITLE) AS CONTENT_ADDED,
       LAG(COUNT (TITLE),1) OVER (ORDER BY MONTH(DATE_ADDED) ) AS PREVIOUS_COUNT 
       FROM CATALOGUE_DATA
       GROUP BY MONTH(DATE_ADDED)
	 )
AS X

--5	Compare MoM count of Indian content added to the platform vs other content added
SELECT MONTH(date_added) AS MONTHS, LABELS, COUNT(TITLE) AS CONTENT 
FROM 
     (SELECT*,
           CASE
     	       WHEN COUNTRY LIKE 'INDIA'
     		        THEN 'INDIA'
     		   ELSE 'OTHERS' 
           END AS LABELS
     FROM CATALOGUE_DATA )
AS X
GROUP BY MONTH(DATE_ADDED),LABELS
ORDER BY MONTHS

--6	Average duration of content
SELECT AVG(duration) AS AVG_DURATION
FROM catalogue_data



--7	Which content is pulling in the most number of users?
SELECT TOP 1 CAD.content_id, TITLE , SUM(USER_DURATION) AS WATCH_TIME
FROM CATALOGUE_DATA AS CAD
INNER JOIN CONSUMPTION_DATA AS COD 
ON CAD.CONTENT_ID=COD.CONTENT_ID
GROUP BY CAD.content_id, TITLE
ORDER BY WATCH_TIME DESC

--8	Different genres of content with the content count
SELECT DISTINCT LISTED_IN , COUNT(TITLE) AS CONTENT_COUNT 
FROM CATALOGUE_DATA
GROUP BY LISTED_IN 
ORDER BY CONTENT_COUNT DESC
 --------------------------------------------------------------------------------------------------------------------
                                      -- TASK-4--
--------------------------------------------------------------------------------------------------------------------

--1	Different rating categories given by the users
select DISTINCT RATING
 FROM RATING_DATA

 --2	Total Content whose rating is not given by the users
SELECT TITLE
FROM RATING_DATA AS RD
INNER JOIN CONSUMPTION_DATA AS COD
ON RD.USERID=COD.USERID
    AND 
   RD.USERSESSIONID=COD.USERSESSIONID 
INNER JOIN CATALOGUE_DATA AS CAD 
ON COD.CONTENT_ID=CAD.CONTENT_ID
WHERE RD.RATING ='NOT_RATED'
GROUP BY TITLE
EXCEPT
SELECT TITLE
FROM RATING_DATA AS RD
INNER JOIN CONSUMPTION_DATA AS COD
ON RD.USERID=COD.USERID
AND 
RD.USERSESSIONID=COD.USERSESSIONID
INNER JOIN CATALOGUE_DATA AS CAD 
ON COD.CONTENT_ID=CAD.CONTENT_ID
WHERE RD.RATING<> 'NOT_RATED'

--3	Contents with the highest rating
SELECT TITLE, COUNT(FEEDBACK_ID) AS RATING_COUNT
FROM RATING_DATA AS RD
INNER JOIN CONSUMPTION_DATA AS COD
ON RD.USERID=COD.USERID
 AND 
 RD.USERSESSIONID=COD.USERSESSIONID
 INNER JOIN CATALOGUE_DATA AS CAD
 ON COD.CONTENT_ID=CAD.CONTENT_ID
 WHERE RD.RATING IN ( 'AWESOME','GOOD')
 GROUP BY TITLE
 ORDER BY RATING_COUNT DESC

 --4	Which content will be removed in the coming time?
 SELECT TITLE, SUM(USER_DURATION) AS WATCH_TIME, COUNT(COD.USERID) AS WATCH_COUNT
FROM RATING_DATA AS RD
INNER JOIN CONSUMPTION_DATA AS COD
ON RD.USERID=COD.USERID
 AND 
 RD.USERSESSIONID=COD.USERSESSIONID
 INNER JOIN CATALOGUE_DATA AS CAD
 ON COD.CONTENT_ID=CAD.CONTENT_ID
 WHERE RD.RATING IN ( 'BAD','DISMISSED','TERRIBLE')
 GROUP BY TITLE
 ORDER BY WATCH_COUNT DESC,WATCH_TIME ASC

 --5	Content from horror categoy
SELECT TITLE 
FROM CATALOGUE_DATA 
WHERE LISTED_IN LIKE ('%HORRO%')
GROUP BY TITLE

--6	Top rated content from India
SELECT TITLE ,COUNT(RD.RATING) AS RATING
FROM RATING_DATA AS RD
INNER JOIN CONSUMPTION_DATA AS COD
ON RD.USERID=COD.USERID
 AND 
 RD.USERSESSIONID=COD.USERSESSIONID
 INNER JOIN CATALOGUE_DATA AS CAD
 ON COD.CONTENT_ID=CAD.CONTENT_ID
 WHERE RD.RATING IN ('AWESOME','GOOD')
    AND 
COUNTRY LIKE ('%INDIA%')
GROUP BY TITLE
ORDER BY RATING DESC
 
 